# Caddy configuration for serving the Flutter Web frontend.
#
# This config ensures that deep links resolve to index.html, applies the
# required CSP directives for Stripe, and adds standard
# security headers.
#
# Place this file on the host and reference it when starting Caddy, e.g.:
#   caddy run --config /etc/caddy/Caddyfile
# Update the `root` directive if your deploy path differs from /var/www/repduel.

www.repduel.com, repduel.com {
  encode zstd gzip
  root * /var/www/repduel

  @static path /assets/* /flutter.js* /favicon.ico /icons/* /manifest.json /robots.txt /sitemap.xml
  handle @static {
    file_server
  }

  handle {
    try_files {path} /index.html
    file_server
  }

  header {
    Content-Security-Policy "
      default-src 'self';
      base-uri 'self';
      object-src 'none';
      script-src 'self' https://js.stripe.com https://m.stripe.network 'unsafe-inline' 'unsafe-eval' blob:;
      style-src  'self' 'unsafe-inline';
      img-src    'self' https: data:;
      font-src   'self' data:;
      connect-src 'self' https://api.repduel.com https://api.stripe.com https://m.stripe.com https://m.stripe.network https://js.stripe.com;
      frame-src  https://js.stripe.com https://hooks.stripe.com;
      worker-src 'self' blob:;
    "
    Referrer-Policy "strict-origin-when-cross-origin"
    X-Content-Type-Options "nosniff"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  }
}

api.repduel.com {
  encode zstd gzip

  @cors_allowed header Origin https://www.repduel.com https://repduel.com
  @preflight method OPTIONS

  respond @preflight 204

  header @cors_allowed {
    Access-Control-Allow-Origin "{header.Origin}"
    Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization"
    Access-Control-Allow-Credentials "true"
    Vary "Origin"
    defer
  }

  reverse_proxy 127.0.0.1:9999 {
    transport http {
      versions h1
    }
  }

  handle_errors {
    header @cors_allowed {
      Access-Control-Allow-Origin "{header.Origin}"
      Access-Control-Allow-Credentials "true"
      Vary "Origin"
      defer
    }
  }
}
