{
    # Global options - use production ACME only
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# =========================
# API (CORS + reverse proxy)
# =========================
# Frontend is served by Render, backend API only
api.repduel.com {
    encode zstd gzip

    # Handle OPTIONS preflight requests first
    @preflight method OPTIONS
    handle @preflight {
        header Access-Control-Allow-Origin "{http.request.header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Allow-Credentials "true"
        header Vary Origin
        respond 204
    }

    # Set CORS headers for allowed origins
    @allowedOrigin1 header Origin https://www.repduel.com
    @allowedOrigin2 header Origin https://repduel.com

    header @allowedOrigin1 Access-Control-Allow-Origin "https://www.repduel.com"
    header @allowedOrigin2 Access-Control-Allow-Origin "https://repduel.com"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
    header Access-Control-Allow-Credentials "true"
    header Vary Origin

    # Static files with caching
    @static {
        path /static/*
    }
    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy 127.0.0.1:9999
    }

    # Proxy all other requests to FastAPI backend
    handle {
        reverse_proxy 127.0.0.1:9999
    }

    # Error handling with CORS
    handle_errors {
        @errorOrigin1 header Origin https://www.repduel.com
        @errorOrigin2 header Origin https://repduel.com
        header @errorOrigin1 Access-Control-Allow-Origin "https://www.repduel.com"
        header @errorOrigin2 Access-Control-Allow-Origin "https://repduel.com"
        header Access-Control-Allow-Credentials "true"
        header Vary Origin
        respond "{http.error.status_code} {http.error.status_text}"
    }
}