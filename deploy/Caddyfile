# =========================
# API (CORS + reverse proxy)
# =========================
api.repduel.com {
    encode zstd gzip

    # Handle OPTIONS preflight requests first
    @preflight method OPTIONS
    handle @preflight {
        header Access-Control-Allow-Origin "{http.request.header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Allow-Credentials "true"
        header Vary Origin
        respond 204
    }

    # Set CORS headers for allowed origins
    @allowedOrigin1 header Origin https://www.repduel.com
    @allowedOrigin2 header Origin https://repduel.com
    
    header @allowedOrigin1 Access-Control-Allow-Origin "https://www.repduel.com"
    header @allowedOrigin2 Access-Control-Allow-Origin "https://repduel.com"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
    header Access-Control-Allow-Credentials "true"
    header Vary Origin

    # Static files with caching - proxy to port 8001
    @static {
        path /static/*
    }
    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        reverse_proxy 127.0.0.1:8001
    }

    # Proxy all other requests to FastAPI on port 8001
    handle {
        reverse_proxy 127.0.0.1:8001
    }

    # Error handling with CORS
    handle_errors {
        @errorOrigin1 header Origin https://www.repduel.com
        @errorOrigin2 header Origin https://repduel.com
        header @errorOrigin1 Access-Control-Allow-Origin "https://www.repduel.com"
        header @errorOrigin2 Access-Control-Allow-Origin "https://repduel.com"
        header Access-Control-Allow-Credentials "true"
        header Vary Origin
        respond "{http.error.status_code} {http.error.status_text}"
    }
}

# =========================
# Frontend (Flutter web)
# =========================
www.repduel.com, repduel.com {
    encode zstd gzip
    root * /var/www/repduel

    # Static files
    @staticFiles {
        path /assets/* /flutter.js* /favicon.ico /icons/* /manifest.json /robots.txt /sitemap.xml
    }
    handle @staticFiles {
        file_server
    }

    # SPA fallback
    handle {
        try_files {path} /index.html
        file_server
    }

    # Security headers
    header {
        Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; script-src 'self' https://js.stripe.com https://m.stripe.network 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' https: data: https://cdn.repduel.com; font-src 'self' data:; connect-src 'self' https://api.repduel.com https://api.stripe.com https://m.stripe.com https://m.stripe.network https://js.stripe.com; frame-src https://js.stripe.com https://hooks.stripe.com; worker-src 'self' blob:;"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Content-Type-Options "nosniff"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}